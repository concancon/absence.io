const Quiz = require('../models/Quiz')
const QuizEntry = require('../models/QuizEntry')

// Display list of all quizes for currently logged in user.
exports.quiz_list = async (req, res, next) => {
  try {
    const userId = res.locals.user._id
    await Quiz.find({ createdBy: userId }).lean().exec((err, quizes) => {
      if (err) { next(err) }
      res.json(quizes)
    })
  } catch (error) { next(error) }
}

// Display detail page for a specific quiz.
exports.quiz_detail = function (req, res) {
  res.send('NOT IMPLEMENTED: quiz detail: ' + req.params.id)
}

// Display quiz create form on GET.
exports.quiz_get = function (req, res) {
  res.send('NOT IMPLEMENTED: quiz create GET')
}

// Handle quiz create on POST.
exports.quiz_create_post = async (req, res, next) => {
  try {
    const createdBy = res.locals.user._id

    const { title, quizEntry } = req.body

    const newQuizEntry = new QuizEntry({ question: quizEntry.question, answer: quizEntry.answer })

    const newQuiz = new Quiz({
      title: title, createdBy: createdBy
    })
    newQuiz.quizEntries.push(newQuizEntry)

    await newQuiz.save()
    res.json(newQuiz)
  } catch (error) {
    next(error)
  }
}

// Display quiz delete form on GET.
exports.quiz_delete_get = function (req, res) {
  res.send('NOT IMPLEMENTED: quiz delete GET')
}

// Handle quiz delete on POST.
exports.quiz_delete_post = function (req, res) {
  res.send('NOT IMPLEMENTED: quiz delete POST')
}

// Handle quiz update on POST.
exports.quiz_update_post = async function (req, res, next, quizId) {
  try {
    const createdBy = res.locals.user._id
    // check if the logged in user is the owner of the quiz
    const quiz = await Quiz.findById(quizId)
    if (quiz) {
      if (quiz.createdBy.equals(createdBy)) {
        const { question, answer } = req.body
        const newEntry = new QuizEntry({ question, answer })
        const validationResult = newEntry.validateSync()
        if (validationResult) {
          return next(' a quiz entry corresponds of one question and one answer. You failed to provide one of them')
        }

        quiz.quizEntries.push(newEntry)

        await quiz.save()
        res.json(quiz)
      } else {
        res.send('sorry you cant edit this quiz. Because it\'s not your quiz \n')
      }
    } else {
      res.send('that quiz id was not found in the database')
    }
  } catch (error) {
    next(error)
  }
}
