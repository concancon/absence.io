const Quiz = require('../models/Quiz')
const QuizEntry = require('../models/QuizEntry')

// Display list of all quizes for currently logged in user.
exports.quiz_list = async (req, res, next) => {
  try {
    const userId = res.locals.user._id
    await Quiz.find({ createdBy: userId }).lean().exec((err, quizes) => {
      if (err) { next(err) }
      res.json(quizes)
    })
  } catch (error) { next(error) }
}

// Display detail page for a specific quiz.
exports.quiz_detail = function (req, res) {
  res.send('NOT IMPLEMENTED: quiz detail: ' + req.params.id)
}

// Display quiz create form on GET.
exports.quiz_get = function (req, res) {
  res.send('NOT IMPLEMENTED: quiz create GET')
}

// Handle quiz create on POST.
exports.quiz_create_post = async (req, res, next) => {
  try {
    const createdBy = res.locals.user._id

    const { title, quizEntry } = req.body

    const newQuizEntry = new QuizEntry(quizEntry)

    const newQuiz = new Quiz({
      title: title, quizEntry: newQuizEntry, createdBy: createdBy
    })
    try {
      await newQuiz.save()
    } catch (error) {
      console.log(error)
    }

    res.json({
      newQuiz
    })
  } catch (error) {
    next(error)
  }
}

// Display quiz delete form on GET.
exports.quiz_delete_get = function (req, res) {
  res.send('NOT IMPLEMENTED: quiz delete GET')
}

// Handle quiz delete on POST.
exports.quiz_delete_post = function (req, res) {
  res.send('NOT IMPLEMENTED: quiz delete POST')
}

// Handle quiz update on POST.
exports.quiz_update_post = async function (req, res, next, quizId) {
  try {
    const createdBy = res.locals.user._id
    // check if the logged in user is the owner of the quiz
    const quiz = await Quiz.findById(quizId)
    if (quiz) {
      if (quiz.createdBy.equals(createdBy)) {
        // get the new question from the body

        const { question, answer } = req.body
        const newEntry = new QuizEntry({ question, answer })
        quiz.quizEntry.push(newEntry)
        try {
          await quiz.save()
        } catch (error) {
          console.log(error)
        }
        res.json(quiz)
      } else {
        res.send('sorry you cant edit \n')
      }
    } else {
      res.send('that quiz id was not found in the database')
    }
  } catch (error) {
    next(error)
  }
}
